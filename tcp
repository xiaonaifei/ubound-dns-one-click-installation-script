#!/bin/bash
# Unbound DNS 服务器一键安装与管理工具箱
# 仓库: https://github.com/xiaonaifei/ubound-dns-one-click-installation-script
# 功能整合: kill-53, dns-Unbound, bbr-update, bbr-core-update,
#           CloudflareSpeedTest-Install.sh, Chinese-font-installation.sh,
#           以及附加的中文语言环境设置和内核优化

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 检查 root 权限
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}请以 root 用户执行此脚本${NC}"
        exit 1
    fi
}

# 获取脚本所在目录的绝对路径（仓库根目录）
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# 显示主菜单
show_menu() {
    clear
    echo -e "${BLUE}══════════════════════════════════════════════${NC}"
    echo -e "${GREEN}        Unbound DNS 服务器一键管理工具箱        ${NC}"
    echo -e "${BLUE}══════════════════════════════════════════════${NC}"
    echo -e "${YELLOW} 脚本仓库: ${SCRIPT_DIR}${NC}"
    echo ""
    echo " 1) 清理 53 端口占用 (kill-53)"
    echo " 2) 安装/配置 Unbound DNS 服务器 (dns-Unbound)"
    echo " 3) 更新 BBR 内核 (bbr-core-update)"
    echo " 4) 调整 BBR 参数 (bbr-update)"
    echo " 5) 安装 Cloudflare 速度测试工具 (CloudflareSpeedTest-Install.sh)"
    echo " 6) 安装中文字体/语言包 (Chinese-font-installation.sh)"
    echo " 7) 设置系统中文语言环境 (locale 配置)"
    echo " 8) 应用系统内核优化参数 (sysctl 调优)"
    echo " 9) 查看当前系统状态 (端口、内核、语言)"
    echo "10) 一键执行推荐设置 (DNS + BBR内核 + 优化)"
    echo " 0) 退出"
    echo -e "${BLUE}══════════════════════════════════════════════${NC}"
    echo -n "请输入选项 [0-10]: "
}

# 执行子脚本，处理文件存在性与权限
run_script() {
    local script_name="$1"
    local script_path="${SCRIPT_DIR}/${script_name}"

    if [ ! -f "$script_path" ]; then
        echo -e "${RED}错误: 未找到脚本 ${script_name}${NC}"
        echo -e "请确保文件存在于仓库目录: ${SCRIPT_DIR}"
        read -p "按 Enter 键返回菜单..."
        return 1
    fi

    if [ ! -x "$script_path" ]; then
        echo -e "${YELLOW}脚本 ${script_name} 缺少执行权限，正在添加...${NC}"
        chmod +x "$script_path"
    fi

    echo -e "${GREEN}正在执行: ${script_name} ...${NC}"
    "$script_path"
    local exit_code=$?
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}✅ ${script_name} 执行完成。${NC}"
    else
        echo -e "${RED}❌ ${script_name} 执行失败，退出码: ${exit_code}${NC}"
    fi
    echo ""
    read -p "按 Enter 键返回菜单..."
}

# 设置中文语言环境（基于之前讨论）
setup_chinese_locale() {
    echo -e "${YELLOW}正在配置系统中文语言环境...${NC}"
    
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
    else
        echo -e "${RED}无法识别操作系统${NC}"
        return 1
    fi

    case $OS in
        ubuntu|debian)
            apt update
            apt install -y language-pack-zh-hans
            locale-gen zh_CN.UTF-8
            echo "LANG=zh_CN.UTF-8" > /etc/default/locale
            echo "LANGUAGE=zh_CN:zh" >> /etc/default/locale
            echo "LC_ALL=zh_CN.UTF-8" >> /etc/default/locale
            ;;
        centos|rhel|rocky|almalinux|fedora)
            if command -v dnf &> /dev/null; then
                dnf install -y glibc-langpack-zh
            else
                yum install -y glibc-langpack-zh
            fi
            localectl set-locale LANG=zh_CN.UTF-8
            ;;
        *)
            echo -e "${RED}不支持的操作系统: $OS${NC}"
            return 1
            ;;
    esac

    echo -e "${GREEN}中文语言环境配置完成，请重新登录或重启系统生效。${NC}"
    read -p "按 Enter 键返回菜单..."
}

# 应用 sysctl 优化（基于之前讨论的优化参数）
apply_sysctl_optimizations() {
    echo -e "${YELLOW}即将应用系统内核参数优化...${NC}"
    
    # 自动备份
    local bk_file="/etc/sysctl.conf.bk_$(date +%Y%m%d_%H%M%S)"
    cp /etc/sysctl.conf "$bk_file"
    echo -e "已备份原配置至: ${bk_file}"

    # 写入优化参数（可根据需要调整）
    cat >> /etc/sysctl.conf <<EOF

# 由 dns-toolkit.sh 添加的优化参数 $(date)
# 网络核心
net.core.default_qdisc = cake
net.core.netdev_max_backlog = 2931
net.core.rmem_max = 19660800
net.core.wmem_max = 19660800
net.core.somaxconn = 1465
net.core.optmem_max = 65536

# TCP 优化
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_rmem = 8192 87380 19660800
net.ipv4.tcp_wmem = 8192 65536 19660800
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1

# 内存管理
vm.swappiness = 10
vm.dirty_ratio = 10
vm.dirty_background_ratio = 5
vm.panic_on_oom = 1
vm.overcommit_memory = 1

# 内核及安全
kernel.panic = 1
kernel.sysrq = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.conf.all.rp_filter = 1
EOF

    sysctl -p
    echo -e "${GREEN}内核参数优化已应用。${NC}"
    read -p "按 Enter 键返回菜单..."
}

# 查看系统状态
show_system_status() {
    echo -e "${BLUE}══════════════════════════════════════════════${NC}"
    echo -e "${GREEN}                系统状态信息                ${NC}"
    echo -e "${BLUE}══════════════════════════════════════════════${NC}"
    
    echo -e "${YELLOW}1. 当前监听 53 端口的进程:${NC}"
    ss -tulpn | grep -E ':(53)\s' || echo "无进程监听 53 端口"
    
    echo -e "\n${YELLOW}2. 当前内核版本:${NC}"
    uname -r
    
    echo -e "\n${YELLOW}3. 当前拥塞控制算法:${NC}"
    sysctl net.ipv4.tcp_congestion_control 2>/dev/null || echo "未配置"
    
    echo -e "\n${YELLOW}4. 当前语言环境:${NC}"
    locale | grep LANG
    
    echo -e "\n${YELLOW}5. 系统发行版:${NC}"
    cat /etc/os-release | grep -E "^(NAME|VERSION)=" || echo "未知"
    
    echo -e "${BLUE}══════════════════════════════════════════════${NC}"
    read -p "按 Enter 键返回菜单..."
}

# 一键执行推荐设置
onekey_install() {
    echo -e "${YELLOW}即将执行一键推荐安装/配置...${NC}"
    echo -e "包含: 清理53端口 + 安装Unbound + 更新BBR内核 + 应用优化"
    echo -e "${RED}此操作可能需要较长时间，请谨慎！${NC}"
    read -p "确认继续？ (y/n): " confirm
    if [[ ! "$confirm" =~ ^[yY](es)?$ ]]; then
        echo "已取消。"
        read -p "按 Enter 键返回菜单..."
        return
    fi

    # 步骤1: 清理53端口
    run_script "kill-53"
    
    # 步骤2: 安装Unbound DNS
    run_script "dns-Unbound"
    
    # 步骤3: 更新BBR内核
    if [ -f "${SCRIPT_DIR}/bbr-core-update" ]; then
        run_script "bbr-core-update"
    else
        echo -e "${YELLOW}未找到 bbr-core-update，尝试 bbr-update...${NC}"
        run_script "bbr-update"
    fi
    
    # 步骤4: 应用内核优化
    apply_sysctl_optimizations
    
    echo -e "${GREEN}一键推荐安装流程执行完毕。${NC}"
    read -p "按 Enter 键返回菜单..."
}

# 主循环
check_root
while true; do
    show_menu
    read choice
    case $choice in
        1) run_script "kill-53" ;;
        2) run_script "dns-Unbound" ;;
        3) run_script "bbr-core-update" ;;
        4) run_script "bbr-update" ;;
        5) run_script "CloudflareSpeedTest-Install.sh" ;;
        6) run_script "Chinese-font-installation.sh" ;;
        7) setup_chinese_locale ;;
        8) apply_sysctl_optimizations ;;
        9) show_system_status ;;
        10) onekey_install ;;
        0)
            echo -e "${GREEN}感谢使用，再见！${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}无效选项，请重新输入。${NC}"
            read -p "按 Enter 键继续..."
            ;;
    esac
done
