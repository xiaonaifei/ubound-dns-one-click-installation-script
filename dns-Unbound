#!/bin/bash

# ===========================================
# Unbound DNS 递归服务器安装脚本 - 递归模式
# 纯递归解析，非转发模式
# ===========================================

set -e  # 遇到错误立即退出

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# 安装配置
INSTALL_DIR="/etc/bot/dns"
LOG_DIR="/var/log/unbound"

# 日志函数
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${PURPLE}[STEP]${NC} $1"
}

# 显示横幅
show_banner() {
    clear
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}     Unbound DNS 递归服务器安装脚本     ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        纯递归模式 | 非转发模式         ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
}

# 检查 root 权限
check_root() {
    if [ "$(id -u)" != "0" ]; then
        log_error "此脚本需要以 root 权限运行"
        exit 1
    fi
    log_info "权限检查通过"
}

# 检测系统类型
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_VERSION=$VERSION_ID
        log_info "检测到系统: $PRETTY_NAME"
    else
        log_error "无法检测操作系统"
        exit 1
    fi
    
    case $OS in
        ubuntu|debian)
            PKG_MANAGER="apt"
            ;;
        centos|rhel|fedora|rocky|almalinux)
            PKG_MANAGER="yum"
            ;;
        *)
            log_error "不支持的发行版: $OS"
            exit 1
            ;;
    esac
}

# 创建目录
create_directories() {
    log_step "创建必要目录..."
    
    mkdir -p "$INSTALL_DIR"
    mkdir -p "$LOG_DIR"
    mkdir -p /etc/bot/config
    
    log_info "目录结构创建完成"
}

# 检测 IPv4/IPv6 支持
detect_ip_support() {
    IPV4_AVAILABLE=0
    IPV6_AVAILABLE=0
    
    # 检测 IPv4 支持
    if ip -4 addr show | grep -q "inet"; then
        IPV4_AVAILABLE=1
    fi
    
    # 检测 IPv6 支持
    if [ -f /proc/sys/net/ipv6/conf/all/disable_ipv6 ]; then
        if [ $(cat /proc/sys/net/ipv6/conf/all/disable_ipv6) -eq 0 ]; then
            IPV6_AVAILABLE=1
        fi
    elif ip -6 addr show | grep -q "inet6"; then
        IPV6_AVAILABLE=1
    fi
    
    log_info "网络支持检测:"
    [ $IPV4_AVAILABLE -eq 1 ] && log_info "  IPv4 支持: 是"
    [ $IPV6_AVAILABLE -eq 1 ] && log_info "  IPv6 支持: 是"
    
    if [ $IPV4_AVAILABLE -eq 0 ] && [ $IPV6_AVAILABLE -eq 0 ]; then
        log_error "未检测到 IPv4 或 IPv6 网络支持"
        exit 1
    fi
}

# 安装 Unbound
install_unbound() {
    log_step "安装 Unbound DNS 服务器..."
    
    case $PKG_MANAGER in
        apt)
            apt update
            DEBIAN_FRONTEND=noninteractive apt install -y unbound unbound-anchor unbound-host
            ;;
        yum)
            if [ "$OS" = "centos" ] || [ "$OS" = "rocky" ] || [ "$OS" = "almalinux" ]; then
                yum install -y epel-release
            fi
            yum install -y unbound unbound-libs
            ;;
    esac
    
    log_info "Unbound 安装完成"
}

# 配置 Unbound 递归模式
configure_unbound_recursive() {
    log_step "配置 Unbound 递归模式..."
    
    # 备份原始配置
    [ -f /etc/unbound/unbound.conf ] && cp /etc/unbound/unbound.conf /etc/unbound/unbound.conf.bak
    
    # 创建递归模式配置
    cat > /etc/unbound/unbound.conf << 'EOF'
# Unbound DNS 服务器配置 - 递归模式
server:
  # ===== 基础配置 =====
  # 启用IPv4/IPv6
  do-ip4: yes
  do-ip6: yes
  do-udp: yes
  do-tcp: yes
  
  # ===== 安全配置 =====
  hide-identity: yes
  hide-version: yes
  harden-glue: yes
  harden-dnssec-stripped: yes
  harden-below-nxdomain: yes
  harden-referral-path: yes
  use-caps-for-id: yes
  
  # ===== 递归解析配置 =====
  # 严格递归模式，不转发到其他DNS
  do-not-query-localhost: no
  
  # 根服务器配置
  root-hints: "/var/lib/unbound/root.hints"
  
  # 自动信任锚文件
  auto-trust-anchor-file: "/var/lib/unbound/root.key"
  
  # DNSSEC验证
  val-permissive-mode: no
  val-clean-additional: yes
  val-log-level: 1
  
  # ===== 访问控制 =====
  access-control: 0.0.0.0/0 refuse
  access-control: 127.0.0.0/8 allow
  access-control: ::0/0 refuse
  access-control: ::1 allow
  
  # ===== 私有网络访问 =====
  access-control: 10.0.0.0/8 allow
  access-control: 172.16.0.0/12 allow
  access-control: 192.168.0.0/16 allow
  access-control: fc00::/7 allow  # 唯一本地地址
  access-control: fd00::/8 allow  # 唯一本地地址
  
  # ===== 性能优化 =====
  num-threads: 2
  msg-cache-size: 64m
  rrset-cache-size: 128m
  key-cache-size: 32m
  neg-cache-size: 4m
  
  # 缓存设置
  cache-min-ttl: 300
  cache-max-ttl: 86400
  infra-cache-numhosts: 10000
  
  # 预取优化
  prefetch: yes
  prefetch-key: yes
  
  # ===== 高级安全 =====
  qname-minimisation: yes
  qname-minimisation-strict: yes
  aggressive-nsec: yes
  rrset-roundrobin: yes
  
  # ===== 响应设置 =====
  minimal-responses: yes
  delay-close: 10000
  
  # ===== 日志配置 =====
  verbosity: 1
  statistics-interval: 0
  statistics-cumulative: no
  extended-statistics: no
  
  # ===== 接口配置 =====
  # 注意：这里暂时留空，后面根据用户输入添加
EOF

    # 下载根服务器文件
    log_info "下载根服务器文件..."
    curl -fsSL -o /var/lib/unbound/root.hints https://www.internic.net/domain/named.cache
    
    # 初始化信任锚
    log_info "初始化 DNSSEC 信任锚..."
    unbound-anchor -a /var/lib/unbound/root.key || {
        log_warn "unbound-anchor 执行失败，尝试备用方法..."
        wget -O /var/lib/unbound/root.key https://raw.githubusercontent.com/NLnetLabs/unbound/master/contrib/root.key
    }
    
    # 设置权限
    chown -R unbound:unbound /var/lib/unbound
    
    log_info "Unbound 递归模式配置完成"
}

# 配置监听端口
configure_listen_ports() {
    log_step "配置监听端口..."
    
    local port=$1
    local interface=$2
    
    # 清除之前的接口配置
    sed -i '/^  interface:/d' /etc/unbound/unbound.conf
    sed -i '/^  port:/d' /etc/unbound/unbound.conf
    
    # 添加监听配置
    if [ $IPV4_AVAILABLE -eq 1 ]; then
        echo "  interface: 0.0.0.0@$port" >> /etc/unbound/unbound.conf
        echo "  access-control: $interface allow" >> /etc/unbound/unbound.conf
    fi
    
    if [ $IPV6_AVAILABLE -eq 1 ]; then
        echo "  interface: ::@$port" >> /etc/unbound/unbound.conf
        echo "  access-control: $interface allow" >> /etc/unbound/unbound.conf
    fi
    
    # 添加端口配置
    echo "  port: $port" >> /etc/unbound/unbound.conf
    
    log_info "已配置监听端口: $port"
    log_info "已允许访问网络: $interface"
}

# 配置递归解析
configure_recursive_resolution() {
    log_step "配置递归解析设置..."
    
    # 确保配置文件中不包含转发配置
    sed -i '/^  forward-addr:/d' /etc/unbound/unbound.conf
    sed -i '/^  forward-zone:/d' /etc/unbound/unbound.conf
    sed -i '/^  name:/d' /etc/unbound/unbound.conf
    
    # 添加递归解析注释
    echo "" >> /etc/unbound/unbound.conf
    echo "  # ===== 递归解析设置 ======" >> /etc/unbound/unbound.conf
    echo "  # 启用递归解析" >> /etc/unbound/unbound.conf
    echo "  recursion: yes" >> /etc/unbound/unbound.conf
    
    # 配置本地服务访问
    echo "  # 允许本地服务访问" >> /etc/unbound/unbound.conf
    echo "  do-not-query-localhost: no" >> /etc/unbound/unbound.conf
    
    log_info "递归解析配置完成"
}

# 添加本地域名解析
configure_local_domains() {
    log_step "配置本地域名解析..."
    
    # 创建本地域配置
    cat >> /etc/unbound/unbound.conf << 'EOF'

# ===== 本地域名解析 =====
local-zone: "local." static
local-data: "router.local. IN A 192.168.1.1"
local-data: "nas.local. IN A 192.168.1.100"
local-data: "server.local. IN A 192.168.1.200"

# 私有域名的正向解析
local-zone: "home.arpa." static
local-data: "home.arpa. IN SOA localhost. admin.localhost. 1 3600 1200 604800 10800"
local-data: "home.arpa. IN NS localhost."

# 私有域名的反向解析
local-zone: "1.168.192.in-addr.arpa." static
local-data: "1.1.168.192.in-addr.arpa. IN PTR router.local."
local-data: "100.1.168.192.in-addr.arpa. IN PTR nas.local."
local-data: "200.1.168.192.in-addr.arpa. IN PTR server.local."
EOF

    log_info "本地域名解析配置完成"
}

# 检查端口占用
check_port_usage() {
    local port=$1
    
    log_info "检查端口 $port 占用情况..."
    
    if ss -tuln | grep -q ":$port "; then
        log_error "端口 $port 被以下进程占用:"
        ss -tuln | grep ":$port "
        return 1
    fi
    
    log_info "端口 $port 可用"
    return 0
}

# 配置防火墙
configure_firewall() {
    local port=$1
    
    log_step "配置防火墙..."
    
    if command -v ufw &> /dev/null; then
        ufw allow $port/tcp
        ufw allow $port/udp
        ufw reload
        log_info "UFW 防火墙已配置，开放端口: $port"
    elif command -v firewall-cmd &> /dev/null; then
        firewall-cmd --add-port=$port/tcp --permanent
        firewall-cmd --add-port=$port/udp --permanent
        firewall-cmd --reload
        log_info "FirewallD 防火墙已配置，开放端口: $port"
    elif command -v iptables &> /dev/null; then
        iptables -A INPUT -p tcp --dport $port -j ACCEPT
        iptables -A INPUT -p udp --dport $port -j ACCEPT
        iptables-save > /etc/iptables/rules.v4
        log_info "iptables 已配置，开放端口: $port"
    else
        log_warn "未检测到防火墙，请手动开放端口: $port (TCP/UDP)"
    fi
}

# 配置系统 DNS
configure_system_dns() {
    local port=$1
    
    log_step "配置系统 DNS..."
    
    # 备份当前配置
    cp /etc/resolv.conf /etc/resolv.conf.bak
    
    # 创建新的 resolv.conf
    cat > /etc/resolv.conf << EOF
# 由 Unbound 递归 DNS 服务器配置
nameserver 127.0.0.1
$([ $IPV6_AVAILABLE -eq 1 ] && echo "nameserver ::1")
options edns0 timeout:2 attempts:3
search local
EOF

    # 如果是非标准端口，需要特殊处理
    if [ "$port" != "53" ]; then
        log_warn "注意：Unbound 使用非标准端口 $port"
        log_warn "系统 DNS 配置为 127.0.0.1，但需要确保应用程序支持指定端口"
        
        # 创建使用说明
        cat > "$INSTALL_DIR/dns_usage.txt" << EOF
Unbound DNS 服务器配置信息：
============================
监听端口: $port
工作模式: 递归模式

使用方法：
1. 直接查询：dig @127.0.0.1 -p $port google.com
2. 配置应用程序时指定端口为 $port
3. 如需系统默认使用，请考虑将 Unbound 改为监听 53 端口

递归 DNS 特点：
- 完全独立解析，不依赖上游 DNS
- 支持 DNSSEC 验证
- 具备本地缓存功能
- 支持 IPv4 和 IPv6
EOF
    fi

    # 防止网络管理器覆盖 (Ubuntu/Debian)
    if [ -f /etc/NetworkManager/NetworkManager.conf ]; then
        if ! grep -q "dns=none" /etc/NetworkManager/NetworkManager.conf; then
            sed -i '/^\[main\]$/a dns=none' /etc/NetworkManager.conf
        fi
    fi
    
    log_info "系统 DNS 已配置为使用本地 Unbound"
}

# 启动服务
start_services() {
    log_step "启动 Unbound 服务..."
    
    systemctl enable unbound
    systemctl restart unbound
    
    # 检查服务状态
    if systemctl is-active --quiet unbound; then
        log_info "Unbound 服务已启动"
    else
        log_error "Unbound 服务启动失败"
        journalctl -u unbound -n 20 --no-pager
        return 1
    fi
    
    return 0
}

# 测试递归解析
test_recursive_resolution() {
    log_step "测试递归解析功能..."
    
    local port=$1
    
    sleep 2  # 等待服务稳定
    
    echo -e "\n${CYAN}=== 测试基础递归解析 ===${NC}"
    
    # 测试 IPv4 递归解析
    if dig @127.0.0.1 -p $port google.com A +short 2>/dev/null | grep -q '[0-9]'; then
        log_info "IPv4 递归解析测试成功 ✓"
    else
        log_error "IPv4 递归解析测试失败"
        return 1
    fi
    
    # 测试 IPv6 递归解析
    if [ $IPV6_AVAILABLE -eq 1 ]; then
        if dig @::1 -p $port google.com AAAA +short 2>/dev/null | grep -q ':'; then
            log_info "IPv6 递归解析测试成功 ✓"
        else
            log_warn "IPv6 递归解析测试失败（可能是网络限制）"
        fi
    fi
    
    # 测试 DNSSEC 验证
    echo -e "\n${CYAN}=== 测试 DNSSEC 验证 ===${NC}"
    if dig @127.0.0.1 -p $port dnssec-failed.org +dnssec 2>/dev/null | grep -q "SERVFAIL"; then
        log_info "DNSSEC 验证功能正常 ✓"
    else
        log_warn "DNSSEC 验证测试异常"
    fi
    
    # 测试本地域名
    echo -e "\n${CYAN}=== 测试本地域名解析 ===${NC}"
    if dig @127.0.0.1 -p $port router.local A +short 2>/dev/null | grep -q '192.168.1.1'; then
        log_info "本地域名解析正常 ✓"
    else
        log_warn "本地域名解析测试失败"
    fi
    
    return 0
}

# 显示配置摘要
show_summary() {
    local port=$1
    
    echo -e "\n${PURPLE}========================================${NC}"
    echo -e "${PURPLE}       Unbound 递归服务器安装完成      ${NC}"
    echo -e "${PURPLE}========================================${NC}"
    
    echo -e "${GREEN}服务器模式:${NC} 纯递归模式（非转发）"
    echo -e "${GREEN}监听端口:${NC} $port (TCP/UDP)"
    
    if [ $IPV4_AVAILABLE -eq 1 ]; then
        echo -e "${GREEN}IPv4 地址:${NC} 0.0.0.0:$port"
    fi
    
    if [ $IPV6_AVAILABLE -eq 1 ]; then
        echo -e "${GREEN}IPv6 地址:${NC} [::]:$port"
    fi
    
    echo -e "\n${CYAN}系统 DNS 配置:${NC}"
    echo "主 DNS: 127.0.0.1"
    [ $IPV6_AVAILABLE -eq 1 ] && echo "备 DNS: ::1"
    
    echo -e "\n${CYAN}测试命令:${NC}"
    echo "IPv4 测试: dig @127.0.0.1 -p $port google.com"
    if [ $IPV6_AVAILABLE -eq 1 ]; then
        echo "IPv6 测试: dig @::1 -p $port google.com"
    fi
    echo "缓存状态: unbound-control stats"
    echo "刷新缓存: unbound-control flush_zone google.com"
    
    echo -e "\n${CYAN}管理命令:${NC}"
    echo "启动服务: systemctl start unbound"
    echo "停止服务: systemctl stop unbound"
    echo "重启服务: systemctl restart unbound"
    echo "查看状态: systemctl status unbound"
    echo "查看日志: journalctl -u unbound -f"
    
    echo -e "\n${CYAN}配置文件:${NC}"
    echo "主配置: /etc/unbound/unbound.conf"
    echo "备份配置: /etc/unbound/unbound.conf.bak"
    echo "安装目录: $INSTALL_DIR"
    
    if [ "$port" != "53" ]; then
        echo -e "\n${YELLOW}重要提示:${NC}"
        echo "Unbound 使用非标准端口 $port"
        echo "应用程序需要指定端口才能使用此DNS服务器"
        echo "使用说明: cat $INSTALL_DIR/dns_usage.txt"
    fi
    
    echo -e "\n${CYAN}递归 DNS 特点:${NC}"
    echo "✓ 完全递归解析，不依赖上游DNS"
    echo "✓ 支持 DNSSEC 验证"
    echo "✓ 具备本地缓存加速"
    echo "✓ 支持 IPv4/IPv6 双栈"
    echo "✓ 包含本地域名解析"
}

# 主函数
main() {
    show_banner
    check_root
    detect_os
    create_directories
    detect_ip_support
    
    # 询问端口配置
    echo -e "\n${CYAN}=== 端口配置 ===${NC}"
    read -p "请输入 Unbound 监听端口 (默认: 5353): " port
    port=${port:-5353}
    
    # 验证端口
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        log_error "端口号必须在 1-65535 之间"
        exit 1
    fi
    
    # 检查端口占用
    if ! check_port_usage $port; then
        read -p "端口 $port 被占用，是否强制使用？(y/N): " force_use
        if [[ ! "$force_use" =~ ^[Yy]$ ]]; then
            read -p "请重新输入端口号: " port
        fi
    fi
    
    # 询问网络访问控制
    echo -e "\n${CYAN}=== 网络访问控制 ===${NC}"
    echo "请选择允许访问的IP范围："
    echo "1) 仅本地 (127.0.0.1/8, ::1)"
    echo "2) 本地 + 私有网络 (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)"
    echo "3) 所有网络 (0.0.0.0/0)"
    read -p "请选择 (1-3, 默认: 2): " access_choice
    access_choice=${access_choice:-2}
    
    case $access_choice in
        1)
            allowed_network="127.0.0.0/8"
            ;;
        2)
            allowed_network="10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.0/8"
            ;;
        3)
            allowed_network="0.0.0.0/0"
            ;;
        *)
            log_error "无效的选择"
            exit 1
            ;;
    esac
    
    # 安装流程
    install_unbound
    configure_unbound_recursive
    configure_listen_ports "$port" "$allowed_network"
    configure_recursive_resolution
    configure_local_domains
    
    # 配置防火墙
    configure_firewall "$port"
    
    # 启动服务
    if ! start_services; then
        log_error "服务启动失败，请检查配置"
        exit 1
    fi
    
    # 配置系统 DNS
    configure_system_dns "$port"
    
    # 测试功能
    if test_recursive_resolution "$port"; then
        log_info "所有测试通过 ✓"
    else
        log_warn "部分测试失败，但安装已完成"
    fi
    
    # 显示摘要
    show_summary "$port"
    
    echo -e "\n${GREEN}========================================${NC}"
    echo -e "${GREEN}       Unbound 递归服务器安装完成      ${NC}"
    echo -e "${GREEN}========================================${NC}"
}

# 运行主函数
main "$@"
