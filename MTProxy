#!/bin/bash

# MTProxy å®Œå…¨è‡ªå®šä¹‰å®‰è£…è„šæœ¬
# æ”¯æŒè‡ªå®šä¹‰ç«¯å£å’Œç”¨æˆ·å

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
check_port() {
    if command -v ss &> /dev/null; then
        if ss -tuln | grep ":$1 " > /dev/null; then
            return 0  # ç«¯å£è¢«å ç”¨
        else
            return 1  # ç«¯å£ç©ºé—²
        fi
    else
        # å¦‚æœæ²¡æœ‰sså‘½ä»¤ï¼Œå‡è®¾ç«¯å£å¯ç”¨
        return 1
    fi
}

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
check_user() {
    if id "$1" &>/dev/null; then
        return 0  # ç”¨æˆ·å­˜åœ¨
    else
        return 1  # ç”¨æˆ·ä¸å­˜åœ¨
    fi
}

# åˆ›å»ºç³»ç»Ÿç”¨æˆ·
create_user() {
    local username=$1
    if ! check_user "$username"; then
        log_info "åˆ›å»ºç”¨æˆ·: $username"
        if useradd -r -s /bin/false -d /opt/mtproxy -m "$username" 2>/dev/null; then
            log_info "ç”¨æˆ· $username åˆ›å»ºæˆåŠŸ"
            return 0
        else
            log_error "æ— æ³•åˆ›å»ºç”¨æˆ· $username"
            return 1
        fi
    else
        log_info "ç”¨æˆ· $username å·²å­˜åœ¨"
        return 0
    fi
}

# è·å–ç”¨æˆ·é…ç½®
get_user_config() {
    echo ""
    echo "========================================"
    echo "   MTProxy è‡ªå®šä¹‰é…ç½®"
    echo "========================================"
    
    # è·å–è¿è¡Œç”¨æˆ·
    while true; do
        read -p "è¯·è¾“å…¥è¿è¡Œç”¨æˆ·å [é»˜è®¤: mtproxy]: " RUN_USER
        RUN_USER=${RUN_USER:-mtproxy}
        
        if [[ "$RUN_USER" == "root" ]]; then
            log_warn "è­¦å‘Š: ä¸å»ºè®®ä½¿ç”¨rootç”¨æˆ·è¿è¡Œ"
            read -p "ç¡®è®¤ä½¿ç”¨rootç”¨æˆ·? [y/N]: " confirm
            if [[ $confirm =~ ^[Yy]$ ]]; then
                break
            else
                continue
            fi
        fi
        
        if ! check_user "$RUN_USER"; then
            log_info "ç”¨æˆ· $RUN_USER ä¸å­˜åœ¨"
            read -p "æ˜¯å¦åˆ›å»ºæ­¤ç”¨æˆ·? [Y/n]: " create_confirm
            if [[ ! $create_confirm =~ ^[Nn]$ ]]; then
                if create_user "$RUN_USER"; then
                    break
                else
                    log_error "ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·"
                    continue
                fi
            else
                log_error "ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·"
                continue
            fi
        else
            break
        fi
    done
    
    # è·å–å®¢æˆ·ç«¯ç«¯å£
    while true; do
        read -p "è¯·è¾“å…¥å®¢æˆ·ç«¯è¿æ¥ç«¯å£ [é»˜è®¤: 443]: " CLIENT_PORT
        CLIENT_PORT=${CLIENT_PORT:-443}
        
        if ! [[ "$CLIENT_PORT" =~ ^[0-9]+$ ]] || [ "$CLIENT_PORT" -lt 1 ] || [ "$CLIENT_PORT" -gt 65535 ]; then
            log_error "ç«¯å£å·å¿…é¡»æ˜¯1-65535ä¹‹é—´çš„æ•°å­—"
            continue
        fi
        
        if check_port $CLIENT_PORT; then
            log_warn "ç«¯å£ $CLIENT_PORT å·²è¢«å ç”¨"
            read -p "æ˜¯å¦ç»§ç»­ä½¿ç”¨æ­¤ç«¯å£? [y/N]: " confirm
            if [[ ! $confirm =~ ^[Yy]$ ]]; then
                continue
            fi
        fi
        
        break
    done
    
    # è·å–ç®¡ç†ç«¯å£
    while true; do
        read -p "è¯·è¾“å…¥æœ¬åœ°ç®¡ç†ç«¯å£ [é»˜è®¤: 8888]: " LOCAL_PORT
        LOCAL_PORT=${LOCAL_PORT:-8888}
        
        if ! [[ "$LOCAL_PORT" =~ ^[0-9]+$ ]] || [ "$LOCAL_PORT" -lt 1 ] || [ "$LOCAL_PORT" -gt 65535 ]; then
            log_error "ç«¯å£å·å¿…é¡»æ˜¯1-65535ä¹‹é—´çš„æ•°å­—"
            continue
        fi
        
        if [ "$LOCAL_PORT" = "$CLIENT_PORT" ]; then
            log_error "ç®¡ç†ç«¯å£ä¸èƒ½ä¸å®¢æˆ·ç«¯ç«¯å£ç›¸åŒ"
            continue
        fi
        
        if check_port $LOCAL_PORT; then
            log_warn "ç«¯å£ $LOCAL_PORT å·²è¢«å ç”¨"
            read -p "æ˜¯å¦ç»§ç»­ä½¿ç”¨æ­¤ç«¯å£? [y/N]: " confirm
            if [[ ! $confirm =~ ^[Yy]$ ]]; then
                continue
            fi
        fi
        
        break
    done
    
    # è·å–å·¥ä½œè¿›ç¨‹æ•°
    while true; do
        read -p "è¯·è¾“å…¥å·¥ä½œè¿›ç¨‹æ•° [é»˜è®¤: 1]: " WORKERS
        WORKERS=${WORKERS:-1}
        
        if ! [[ "$WORKERS" =~ ^[0-9]+$ ]] || [ "$WORKERS" -lt 1 ] || [ "$WORKERS" -gt 16 ]; then
            log_error "å·¥ä½œè¿›ç¨‹æ•°å¿…é¡»æ˜¯1-16ä¹‹é—´çš„æ•°å­—"
            continue
        fi
        
        break
    done
    
    log_info "é…ç½®å®Œæˆ:"
    log_info "  è¿è¡Œç”¨æˆ·: $RUN_USER"
    log_info "  å®¢æˆ·ç«¯ç«¯å£: $CLIENT_PORT"
    log_info "  ç®¡ç†ç«¯å£: $LOCAL_PORT"
    log_info "  å·¥ä½œè¿›ç¨‹: $WORKERS"
}

# æ£€æŸ¥rootæƒé™
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
}

# æ£€æµ‹ç³»ç»Ÿ
detect_os() {
    if [[ -f /etc/redhat-release ]]; then
        OS="centos"
    elif [[ -f /etc/debian_version ]]; then
        OS="debian"
    elif grep -Eqi "ubuntu|debian" /etc/issue; then
        OS="ubuntu"
    else
        log_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ"
        exit 1
    fi
    log_info "æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS"
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    log_info "å®‰è£…ä¾èµ–åŒ…..."
    
    case $OS in
        centos)
            yum update -y
            yum install -y epel-release
            yum install -y git gcc make curl wget openssl-devel zlib-devel
            ;;
        ubuntu|debian)
            apt update -y
            apt install -y git gcc make curl wget build-essential libssl-dev zlib1g-dev
            ;;
    esac
}

# ç¼–è¯‘å®‰è£…MTProxy
compile_mtproxy() {
    log_info "ç¼–è¯‘å®‰è£… MTProxy..."
    
    cd /tmp
    rm -rf MTProxy
    git clone https://github.com/TelegramMessenger/MTProxy.git
    cd MTProxy
    
    make -j$(nproc)
    
    # å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„
    cp objs/bin/mtproto-proxy /usr/local/bin/
    chmod +x /usr/local/bin/mtproto-proxy
    
    log_info "MTProxy ç¼–è¯‘å®Œæˆ"
}

# è·å–é…ç½®æ–‡ä»¶
get_configs() {
    log_info "ä¸‹è½½é…ç½®æ–‡ä»¶..."
    
    mkdir -p /opt/mtproxy
    cd /opt/mtproxy
    
    # ä¸‹è½½å®˜æ–¹é…ç½®æ–‡ä»¶
    if ! curl -s -o proxy-secret https://core.telegram.org/getProxySecret; then
        log_warn "æ— æ³•ä¸‹è½½ proxy-secretï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ"
        openssl rand -hex 16 > proxy-secret
    fi
    
    if ! curl -s -o proxy-multi.conf https://core.telegram.org/getProxyConfig; then
        log_error "æ— æ³•ä¸‹è½½ proxy-multi.conf"
        exit 1
    fi
    
    # ç”Ÿæˆè‡ªå®šä¹‰secret (32ä½åå…­è¿›åˆ¶)
    SECRET=$(openssl rand -hex 16)
    echo "$SECRET" > secret.txt
    
    # è®¾ç½®æ–‡ä»¶æƒé™
    chown -R $RUN_USER:$RUN_USER /opt/mtproxy/
    chmod 644 /opt/mtproxy/proxy-secret
    chmod 644 /opt/mtproxy/proxy-multi.conf
    chmod 600 /opt/mtproxy/secret.txt
    
    log_info "é…ç½®æ–‡ä»¶ä¸‹è½½å®Œæˆ"
}

# é…ç½®ç³»ç»ŸæœåŠ¡
setup_service() {
    log_info "é…ç½®ç³»ç»ŸæœåŠ¡..."
    
    # è¯»å–secret
    SECRET=$(cat /opt/mtproxy/secret.txt)
    
    # åœæ­¢æ—§æœåŠ¡
    systemctl stop mtproxy 2>/dev/null || true
    
    # åˆ›å»ºæœåŠ¡æ–‡ä»¶
    cat > /etc/systemd/system/mtproxy.service << EOF
[Unit]
Description=MTProxy Telegram Proxy
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/mtproxy
ExecStart=/usr/local/bin/mtproto-proxy -u $RUN_USER -p $LOCAL_PORT -H $CLIENT_PORT -S $SECRET --aes-pwd proxy-secret proxy-multi.conf -M $WORKERS
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

    # é‡æ–°åŠ è½½systemd
    systemctl daemon-reload
    systemctl enable mtproxy
    
    log_info "ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ"
}

# æ˜¾ç¤ºå®‰è£…ä¿¡æ¯
show_info() {
    SECRET=$(cat /opt/mtproxy/secret.txt)
    IP=$(curl -s -4 ifconfig.co)
    
    if [[ -z "$IP" ]]; then
        IP=$(hostname -I | awk '{print $1}')
    fi
    
    echo ""
    echo "========================================"
    echo "   ğŸ‰ MTProxy å®‰è£…æˆåŠŸ!"
    echo "========================================"
    echo "æœåŠ¡å™¨é…ç½®:"
    echo "  ğŸ“¡ æœåŠ¡å™¨IP: $IP"
    echo "  ğŸ”Œ å®¢æˆ·ç«¯ç«¯å£: $CLIENT_PORT"
    echo "  ğŸ› ï¸  ç®¡ç†ç«¯å£: $LOCAL_PORT"
    echo "  ğŸ‘¤ è¿è¡Œç”¨æˆ·: $RUN_USER"
    echo "  ğŸ”‘ å¯†é’¥: $SECRET"
    echo "  ğŸš€ å·¥ä½œè¿›ç¨‹: $WORKERS"
    echo ""
    echo "Telegram ä»£ç†é“¾æ¥:"
    echo "  ğŸ“± tg://proxy?server=$IP&port=$CLIENT_PORT&secret=$SECRET"
    echo ""
    echo "ç½‘é¡µç‰ˆé“¾æ¥:"
    echo "  ğŸ’» https://t.me/proxy?server=$IP&port=$CLIENT_PORT&secret=$SECRET"
    echo ""
    echo "ç®¡ç†å‘½ä»¤:"
    echo "  systemctl start mtproxy     # å¯åŠ¨"
    echo "  systemctl stop mtproxy      # åœæ­¢"
    echo "  systemctl restart mtproxy   # é‡å¯"
    echo "  systemctl status mtproxy    # çŠ¶æ€"
    echo "  journalctl -u mtproxy -f    # æ—¥å¿—"
    echo "  curl http://localhost:$LOCAL_PORT/stats  # ç»Ÿè®¡"
    echo ""
    echo "é…ç½®æ–‡ä»¶ä½ç½®: /opt/mtproxy/"
    echo "å¯†é’¥å¤‡ä»½: /opt/mtproxy/secret.txt"
    echo "========================================"
}

# ä¸»å®‰è£…å‡½æ•°
main_install() {
    log_info "å¼€å§‹å®‰è£… MTProxy..."
    
    check_root
    detect_os
    get_user_config
    install_dependencies
    compile_mtproxy
    get_configs
    setup_service
    
    # å¯åŠ¨æœåŠ¡
    log_info "å¯åŠ¨ MTProxy æœåŠ¡..."
    systemctl start mtproxy
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    sleep 3
    if systemctl is-active --quiet mtproxy; then
        log_info "MTProxy æœåŠ¡å¯åŠ¨æˆåŠŸ"
        show_info
    else
        log_error "MTProxy æœåŠ¡å¯åŠ¨å¤±è´¥"
        journalctl -u mtproxy --no-pager -l
        exit 1
    fi
}

# å¸è½½å‡½æ•°
uninstall() {
    log_warn "å¼€å§‹å¸è½½ MTProxy..."
    
    systemctl stop mtproxy 2>/dev/null || true
    systemctl disable mtproxy 2>/dev/null || true
    rm -f /etc/systemd/system/mtproxy.service
    rm -f /usr/local/bin/mtproto-proxy
    rm -rf /opt/mtproxy
    systemctl daemon-reload
    
    log_info "MTProxy å·²å¸è½½"
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
usage() {
    echo "ä½¿ç”¨æ–¹æ³•: $0 [é€‰é¡¹]"
    echo "é€‰é¡¹:"
    echo "  install   å®‰è£… MTProxy"
    echo "  uninstall å¸è½½ MTProxy"
    echo "  help      æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
}

# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
echo "========================================"
echo "    MTProxy å®Œå…¨è‡ªå®šä¹‰å®‰è£…è„šæœ¬"
echo "========================================"
echo "æ”¯æŒ:"
echo "  âœ“ è‡ªå®šä¹‰è¿è¡Œç”¨æˆ·"
echo "  âœ“ è‡ªå®šä¹‰å®¢æˆ·ç«¯ç«¯å£"
echo "  âœ“ è‡ªå®šä¹‰ç®¡ç†ç«¯å£"
echo "  âœ“ è‡ªå®šä¹‰å·¥ä½œè¿›ç¨‹æ•°"
echo "========================================"

# ä¸»é€»è¾‘
case "${1:-install}" in
    install)
        main_install
        ;;
    uninstall)
        uninstall
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "æœªçŸ¥é€‰é¡¹: $1"
        usage
        exit 1
        ;;
esac
