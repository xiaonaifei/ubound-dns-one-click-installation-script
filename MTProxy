#!/bin/bash

# MTProxy å®˜æ–¹æ ‡å‡†å®‰è£…è„šæœ¬
# åŸºäº https://github.com/TelegramMessenger/MTProxy

set -e

echo "========================================"
echo "    MTProxy å®˜æ–¹æ ‡å‡†å®‰è£…è„šæœ¬"
echo "========================================"

# æ£€æŸ¥rootæƒé™
if [[ $EUID -ne 0 ]]; then
    echo "é”™è¯¯: è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# å®‰è£…ä¾èµ–
echo "æ­¥éª¤1: å®‰è£…ä¾èµ–..."
if command -v apt-get >/dev/null 2>&1; then
    apt update -y
    apt install -y git build-essential curl wget
elif command -v yum >/dev/null 2>&1; then
    yum update -y
    yum install -y git gcc make curl wget
fi

# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p /opt/mtproxy
cd /opt/mtproxy

# ä¸‹è½½æºç 
echo "æ­¥éª¤2: ä¸‹è½½MTProxyæºç ..."
rm -rf MTProxy
git clone https://github.com/TelegramMessenger/MTProxy.git
cd MTProxy

# ç¼–è¯‘
echo "æ­¥éª¤3: ç¼–è¯‘MTProxy..."
make -j$(nproc)
cp objs/bin/mtproto-proxy /usr/local/bin/

# è·å–å®˜æ–¹é…ç½®æ–‡ä»¶
echo "æ­¥éª¤4: è·å–å®˜æ–¹é…ç½®æ–‡ä»¶..."
cd /opt/mtproxy
wget -q -O proxy-secret https://core.telegram.org/getProxySecret
wget -q -O proxy-multi.conf https://core.telegram.org/getProxyConfig

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
if [[ ! -f "proxy-secret" ]] || [[ ! -s "proxy-secret" ]]; then
    echo "é”™è¯¯: æ— æ³•ä¸‹è½½ proxy-secret"
    exit 1
fi

if [[ ! -f "proxy-multi.conf" ]] || [[ ! -s "proxy-multi.conf" ]]; then
    echo "é”™è¯¯: æ— æ³•ä¸‹è½½ proxy-multi.conf"
    exit 1
fi

# ç”Ÿæˆsecret (32ä½åå…­è¿›åˆ¶)
echo "æ­¥éª¤5: ç”Ÿæˆä»£ç†å¯†é’¥..."
SECRET=$(openssl rand -hex 16)
echo "ç”Ÿæˆçš„å¯†é’¥: $SECRET"
echo $SECRET > /opt/mtproxy/secret.txt

# è·å–ç”¨æˆ·é…ç½®
echo ""
echo "é…ç½®MTProxyå‚æ•°:"
read -p "è¯·è¾“å…¥è¿è¡Œç”¨æˆ· [é»˜è®¤: nobody]: " RUN_USER
RUN_USER=${RUN_USER:-nobody}

read -p "è¯·è¾“å…¥å®¢æˆ·ç«¯è¿æ¥ç«¯å£ [é»˜è®¤: 443]: " CLIENT_PORT
CLIENT_PORT=${CLIENT_PORT:-443}

read -p "è¯·è¾“å…¥æœ¬åœ°ç®¡ç†ç«¯å£ [é»˜è®¤: 8888]: " LOCAL_PORT
LOCAL_PORT=${LOCAL_PORT:-8888}

read -p "è¯·è¾“å…¥å·¥ä½œè¿›ç¨‹æ•° [é»˜è®¤: 1]: " WORKERS
WORKERS=${WORKERS:-1}

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
check_port() {
    if ss -tuln | grep ":$1 " > /dev/null; then
        return 0
    else
        return 1
    fi
}

if check_port $CLIENT_PORT; then
    echo "è­¦å‘Š: ç«¯å£ $CLIENT_PORT å·²è¢«å ç”¨ï¼Œå¯èƒ½éœ€è¦æ›´æ¢"
fi

if check_port $LOCAL_PORT; then
    echo "è­¦å‘Š: ç«¯å£ $LOCAL_PORT å·²è¢«å ç”¨ï¼Œå¯èƒ½éœ€è¦æ›´æ¢"
fi

# åˆ›å»ºæœåŠ¡æ–‡ä»¶
echo "æ­¥éª¤6: åˆ›å»ºç³»ç»ŸæœåŠ¡..."
cat > /etc/systemd/system/mtproxy.service << EOF
[Unit]
Description=MTProxy Telegram Proxy
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/mtproxy
ExecStart=/usr/local/bin/mtproto-proxy -u $RUN_USER -p $LOCAL_PORT -H $CLIENT_PORT -S $SECRET --aes-pwd proxy-secret proxy-multi.conf -M $WORKERS
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
echo "æ­¥éª¤7: å¯åŠ¨æœåŠ¡..."
systemctl daemon-reload
systemctl enable mtproxy
systemctl start mtproxy

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "æ­¥éª¤8: æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
sleep 3

if systemctl is-active --quiet mtproxy; then
    echo "âœ… MTProxy æœåŠ¡å¯åŠ¨æˆåŠŸ"
else
    echo "âŒ MTProxy æœåŠ¡å¯åŠ¨å¤±è´¥"
    echo "æŸ¥çœ‹æ—¥å¿—: journalctl -u mtproxy -n 20"
    exit 1
fi

# è·å–æœåŠ¡å™¨IP
IP=$(curl -s -4 ifconfig.co || curl -s -6 ifconfig.co || hostname -I | awk '{print $1}')

# ç”Ÿæˆä»£ç†é“¾æ¥
TG_LINK="tg://proxy?server=$IP&port=$CLIENT_PORT&secret=$SECRET"
TG_HTTP_LINK="https://t.me/proxy?server=$IP&port=$CLIENT_PORT&secret=$SECRET"

echo ""
echo "========================================"
echo "    ğŸ‰ MTProxy å®‰è£…æˆåŠŸ!"
echo "========================================"
echo "æœåŠ¡å™¨é…ç½®:"
echo "  ğŸ“¡ æœåŠ¡å™¨IP: $IP"
echo "  ğŸ”Œ å®¢æˆ·ç«¯ç«¯å£: $CLIENT_PORT"
echo "  ğŸ› ï¸  ç®¡ç†ç«¯å£: $LOCAL_PORT"
echo "  ğŸ‘¤ è¿è¡Œç”¨æˆ·: $RUN_USER"
echo "  ğŸ”‘ å¯†é’¥: $SECRET"
echo "  ğŸš€ å·¥ä½œè¿›ç¨‹: $WORKERS"
echo ""
echo "Telegram ä»£ç†é“¾æ¥:"
echo "  ğŸ“± $TG_LINK"
echo ""
echo "ç½‘é¡µç‰ˆé“¾æ¥:"
echo "  ğŸ’» $TG_HTTP_LINK"
echo ""
echo "ç®¡ç†å‘½ä»¤:"
echo "  systemctl status mtproxy    # æŸ¥çœ‹çŠ¶æ€"
echo "  systemctl restart mtproxy   # é‡å¯æœåŠ¡"
echo "  journalctl -u mtproxy -f    # æŸ¥çœ‹æ—¥å¿—"
echo "  curl http://localhost:$LOCAL_PORT/stats  # æŸ¥çœ‹ç»Ÿè®¡"
echo ""
echo "ä¸‹ä¸€æ­¥:"
echo "  1. åœ¨Telegramä¸­ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥é…ç½®ä»£ç†"
echo "  2. å¯é€‰: é€šè¿‡ @MTProxybot æ³¨å†Œä»£ç†è·å–ä»£ç†æ ‡ç­¾"
echo "  3. ä½¿ç”¨ -P <proxy_tag> å‚æ•°é‡æ–°å¯åŠ¨æœåŠ¡"
echo ""
echo "é…ç½®æ–‡ä»¶ä½ç½®: /opt/mtproxy/"
echo "å¯†é’¥å¤‡ä»½: /opt/mtproxy/secret.txt"
echo "========================================"
