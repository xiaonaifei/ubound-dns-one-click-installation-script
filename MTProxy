#!/bin/bash

# MTProxy ä¸€é”®å®‰è£…è„šæœ¬ - å·²éªŒè¯å¯ç”¨ç‰ˆæœ¬

set -e

echo "========================================"
echo "    MTProxy ä¸€é”®å®‰è£…è„šæœ¬"
echo "========================================"

# æ£€æŸ¥rootæƒé™
if [[ $EUID -ne 0 ]]; then
    echo "é”™è¯¯: è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# å®‰è£…ä¾èµ–
echo "å®‰è£…ä¾èµ–åŒ…..."
if command -v apt-get >/dev/null 2>&1; then
    apt update -y
    apt install -y git build-essential curl wget
elif command -v yum >/dev/null 2>&1; then
    yum update -y
    yum install -y git gcc make curl wget
else
    echo "ä¸æ”¯æŒçš„Linuxå‘è¡Œç‰ˆ"
    exit 1
fi

# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p /opt/mtproxy
cd /opt/mtproxy

# ä¸‹è½½æºç 
echo "ä¸‹è½½MTProxyæºç ..."
rm -rf MTProxy
git clone https://github.com/TelegramMessenger/MTProxy.git
cd MTProxy

# ç¼–è¯‘å®‰è£…
echo "ç¼–è¯‘MTProxy..."
make
cp objs/bin/mtproto-proxy /usr/local/bin/

# èŽ·å–é…ç½®æ–‡ä»¶
echo "ä¸‹è½½ä»£ç†é…ç½®æ–‡ä»¶..."
cd /opt/mtproxy
wget -O proxy-secret https://core.telegram.org/getProxySecret
wget -O proxy-multi.conf https://core.telegram.org/getProxyConfig

# ç”Ÿæˆsecret
CUSTOM_SECRET=$(head -c 16 /dev/urandom | xxd -ps)
echo $CUSTOM_SECRET > /opt/mtproxy/secret.txt

# è®¾ç½®ä»£ç†ç«¯å£ï¼ˆé¿å…ä½¿ç”¨å¸¸è§ç«¯å£ï¼‰
PROXY_PORT=3443
MGMT_PORT=8888

# åˆ›å»ºæœåŠ¡æ–‡ä»¶
cat > /etc/systemd/system/mtproxy.service << EOF
[Unit]
Description=MTProxy Service
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/mtproxy
ExecStart=/usr/local/bin/mtproto-proxy -u nobody -p $MGMT_PORT -H $PROXY_PORT -S $CUSTOM_SECRET --aes-pwd proxy-secret proxy-multi.conf -M 1
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
systemctl daemon-reload
systemctl enable mtproxy
systemctl start mtproxy

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sleep 3
if systemctl is-active --quiet mtproxy; then
    echo "MTProxyæœåŠ¡å¯åŠ¨æˆåŠŸ"
else
    echo "MTProxyæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—: journalctl -u mtproxy -f"
    exit 1
fi

# èŽ·å–IP
IP=$(curl -s -4 ifconfig.me)
if [ -z "$IP" ]; then
    IP=$(hostname -I | awk '{print $1}')
fi

# ç”Ÿæˆé“¾æŽ¥
TG_LINK="tg://proxy?server=$IP&port=$PROXY_PORT&secret=$CUSTOM_SECRET"
TG_HTTP_LINK="https://t.me/proxy?server=$IP&port=$PROXY_PORT&secret=$CUSTOM_SECRET"

echo ""
echo "========================================"
echo "    MTProxy å®‰è£…æˆåŠŸ!"
echo "========================================"
echo "æœåŠ¡å™¨: $IP"
echo "ç«¯å£: $PROXY_PORT" 
echo "å¯†é’¥: $CUSTOM_SECRET"
echo ""
echo "ðŸ“± Telegramä»£ç†é“¾æŽ¥:"
echo "$TG_LINK"
echo ""
echo "ðŸ’» ç½‘é¡µç‰ˆé“¾æŽ¥:"
echo "$TG_HTTP_LINK"
echo ""
echo "ðŸ”§ ç®¡ç†å‘½ä»¤:"
echo "systemctl status mtproxy  # æŸ¥çœ‹çŠ¶æ€"
echo "systemctl restart mtproxy # é‡å¯æœåŠ¡"
echo "systemctl stop mtproxy    # åœæ­¢æœåŠ¡"
echo ""
echo "ðŸ’¾ å¯†é’¥å¤‡ä»½æ–‡ä»¶: /opt/mtproxy/secret.txt"
echo "========================================"
