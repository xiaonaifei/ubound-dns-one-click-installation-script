#!/bin/bash

# MTProxy ä¸€é”®å®‰è£…è„šæœ¬ - ç”Ÿæˆå¯ç›´æ¥å¯¼å…¥TGçš„é“¾æ¥
# åŸºäº https://github.com/wuxingzhidi/ubound-dns-one-click-installation-script/blob/main/MTProxy

set -e

echo "========================================"
echo "    MTProxy ä¸€é”®å®‰è£…è„šæœ¬"
echo "    ç”Ÿæˆå¯ç›´æ¥å¯¼å…¥TGçš„ä»£ç†é“¾æ¥"
echo "========================================"

# æ£€æŸ¥rootæƒé™
if [[ $EUID -ne 0 ]]; then
    echo "é”™è¯¯: è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# è·å–ç”¨æˆ·è¾“å…¥çš„ç«¯å£
read -p "è¯·è¾“å…¥ä»£ç†ç«¯å£ [é»˜è®¤: 443]: " PROXY_PORT
PROXY_PORT=${PROXY_PORT:-443}

# å®‰è£…ä¾èµ–
echo "å®‰è£…ä¾èµ–åŒ…..."
if command -v apt-get >/dev/null 2>&1; then
    apt update -y
    apt install -y git curl wget build-essential libssl-dev zlib1g-dev
elif command -v yum >/dev/null 2>&1; then
    yum update -y
    yum install -y epel-release
    yum install -y git curl wget openssl-devel zlib-devel make gcc
else
    echo "ä¸æ”¯æŒçš„Linuxå‘è¡Œç‰ˆ"
    exit 1
fi

# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p /opt/mtproxy
cd /opt/mtproxy

# ä¸‹è½½æºç 
echo "ä¸‹è½½MTProxyæºç ..."
if [[ -d "MTProxy" ]]; then
    rm -rf MTProxy
fi
git clone https://github.com/TelegramMessenger/MTProxy.git

# ç¼–è¯‘å®‰è£…
cd MTProxy
make -j$(nproc)
cp objs/bin/mtproto-proxy /usr/local/bin/

# è·å–é…ç½®æ–‡ä»¶
echo "è·å–ä»£ç†é…ç½®æ–‡ä»¶..."
curl -s https://core.telegram.org/getProxySecret -o /opt/mtproxy/proxy-secret || openssl rand -hex 16 > /opt/mtproxy/proxy-secret
curl -s https://core.telegram.org/getProxyConfig -o /opt/mtproxy/proxy-multi.conf

# ç”Ÿæˆsecretï¼ˆddæ ¼å¼ï¼ŒTGä¸“ç”¨ï¼‰
CUSTOM_SECRET=$(head -c 16 /dev/urandom | xxd -ps)
echo $CUSTOM_SECRET > /opt/mtproxy/proxy-secret-custom

# åˆ›å»ºæœåŠ¡æ–‡ä»¶
cat > /etc/systemd/system/mtproxy.service << EOF
[Unit]
Description=MTProxy Telegram Proxy
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/mtproxy
ExecStart=/usr/local/bin/mtproto-proxy -u nobody -p 8888 -H $PROXY_PORT -S ${CUSTOM_SECRET} --aes-pwd /opt/mtproxy/proxy-secret /opt/mtproxy/proxy-multi.conf -M 1
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
systemctl daemon-reload
systemctl enable mtproxy
systemctl start mtproxy

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 3

# è·å–å…¬ç½‘IP
IP=$(curl -s -4 ifconfig.co)
if [ -z "$IP" ]; then
    IP=$(curl -s -6 ifconfig.co)
fi

# ç”ŸæˆTGä»£ç†é“¾æ¥
TG_LINK="tg://proxy?server=${IP}&port=${PROXY_PORT}&secret=${CUSTOM_SECRET}"
TG_HTTP_LINK="https://t.me/proxy?server=${IP}&port=${PROXY_PORT}&secret=${CUSTOM_SECRET}"

echo ""
echo "========================================"
echo "    MTProxy å®‰è£…å®Œæˆ!"
echo "========================================"
echo "ä»£ç†æœåŠ¡å™¨: $IP"
echo "ä»£ç†ç«¯å£: $PROXY_PORT"
echo "Secret Key: $CUSTOM_SECRET"
echo ""
echo "âœ… ç›´æ¥ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥å³å¯åœ¨Telegramä¸­é…ç½®ä»£ç†:"
echo ""
echo "ğŸ“± æ‰‹æœºTGç›´æ¥ç‚¹å‡»:"
echo "$TG_LINK"
echo ""
echo "ğŸ’» ç”µè„‘TGç›´æ¥ç‚¹å‡»:"
echo "$TG_HTTP_LINK"
echo ""
echo "ğŸ“‹ æ‰‹åŠ¨é…ç½®ä¿¡æ¯:"
echo "æœåŠ¡å™¨: $IP"
echo "ç«¯å£: $PROXY_PORT"
echo "å¯†é’¥: $CUSTOM_SECRET"
echo ""
echo "ğŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤:"
echo "å¯åŠ¨: systemctl start mtproxy"
echo "åœæ­¢: systemctl stop mtproxy"
echo "é‡å¯: systemctl restart mtproxy"
echo "çŠ¶æ€: systemctl status mtproxy"
echo "========================================"

# ç”ŸæˆäºŒç»´ç ï¼ˆå¯é€‰ï¼‰
if command -v qrencode >/dev/null 2>&1; then
    echo ""
    echo "ğŸ“± ä»£ç†é“¾æ¥äºŒç»´ç :"
    qrencode -t ANSI "$TG_LINK"
elif command -v apt-get >/dev/null 2>&1; then
    apt install -y qrencode
    echo "ğŸ“± ä»£ç†é“¾æ¥äºŒç»´ç :"
    qrencode -t ANSI "$TG_LINK"
elif command -v yum >/dev/null 2>&1; then
    yum install -y qrencode
    echo "ğŸ“± ä»£ç†é“¾æ¥äºŒç»´ç :"
    qrencode -t ANSI "$TG_LINK"
fi